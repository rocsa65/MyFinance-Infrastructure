version: '3.8'version: '3.8'



services:services:

  nginx-proxy:  nginx-proxy:

    image: nginx:alpine    image: nginx:alpine

    container_name: myfinance-nginx-proxy    container_name: myfinance-nginx-proxy

    restart: unless-stopped    restart: unless-stopped

    ports:    ports:

      - "80:80"      - "80:80"

      - "443:443"      - "443:443"

    volumes:    volumes:

      - ./blue-green.conf:/etc/nginx/conf.d/default.conf      - nginx_config:/etc/nginx/conf.d

      - ./nginx.conf:/etc/nginx/nginx.conf      - nginx_main_config:/etc/nginx

      - nginx_logs:/var/log/nginx      - nginx_logs:/var/log/nginx

    environment:    environment:

      - NGINX_UPSTREAM=${NGINX_UPSTREAM:-blue}      - NGINX_UPSTREAM=${NGINX_UPSTREAM:-blue}

    networks:    networks:

      - myfinance-network      - myfinance-network

    # Copy config files from a helper container on first start

volumes:    depends_on:

  nginx_logs:      - nginx-config-init

    driver: local

  # Helper container to initialize nginx config files

networks:  nginx-config-init:

  myfinance-network:    image: busybox

    external: true    container_name: nginx-config-init

    name: myfinance-network    volumes:

      - nginx_config:/target/conf.d
      - nginx_main_config:/target/main
      - ./blue-green.conf:/source/blue-green.conf:ro
      - ./nginx.conf:/source/nginx.conf:ro
    command: sh -c "cp /source/blue-green.conf /target/conf.d/default.conf && cp /source/nginx.conf /target/main/nginx.conf && echo 'Config files copied'"

volumes:
  nginx_logs:
    driver: local
  nginx_config:
    driver: local
  nginx_main_config:
    driver: local

networks:
  myfinance-network:
    external: true
    name: myfinance-network