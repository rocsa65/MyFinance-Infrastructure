pipeline {
    agent any
    
    parameters {
        choice(
            name: 'RELEASE_TYPE',
            choices: ['frontend', 'backend', 'full'],
            description: 'Type of release to perform'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Skip test execution (not recommended for production)'
        )
        booleanParam(
            name: 'AUTO_DEPLOY',
            defaultValue: false,
            description: 'Automatically deploy to production after successful tests'
        )
    }
    
    environment {
        DOCKER_REGISTRY = 'ghcr.io/rocsa65'
        GITHUB_ORG = 'rocsa65'
        RELEASE_NUMBER = generateReleaseNumber()
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    echo "Starting release pipeline for: ${params.RELEASE_TYPE}"
                    echo "Release Number: ${env.RELEASE_NUMBER}"
                }
            }
        }
        
        stage('Frontend Release') {
            when {
                anyOf {
                    expression { params.RELEASE_TYPE == 'frontend' }
                    expression { params.RELEASE_TYPE == 'full' }
                }
            }
            steps {
                script {
                    build job: 'MyFinance/Frontend-Release', parameters: [
                        string(name: 'RELEASE_NUMBER', value: env.RELEASE_NUMBER),
                        booleanParam(name: 'SKIP_TESTS', value: params.SKIP_TESTS)
                    ]
                }
            }
        }
        
        stage('Backend Release') {
            when {
                anyOf {
                    expression { params.RELEASE_TYPE == 'backend' }
                    expression { params.RELEASE_TYPE == 'full' }
                }
            }
            steps {
                script {
                    build job: 'MyFinance/Backend-Release', parameters: [
                        string(name: 'RELEASE_NUMBER', value: env.RELEASE_NUMBER),
                        booleanParam(name: 'SKIP_TESTS', value: params.SKIP_TESTS)
                    ]
                }
            }
        }
        
        stage('Full System Test') {
            when {
                expression { params.RELEASE_TYPE == 'full' }
            }
            steps {
                script {
                    echo "Running full system integration tests"
                    sh '/var/jenkins_home/scripts/monitoring/system-health-check.sh green'
                }
            }
        }
        
        stage('Production Deployment') {
            when {
                expression { params.AUTO_DEPLOY || input(message: 'Deploy to Production?', ok: 'Deploy') }
            }
            steps {
                script {
                    echo "Deploying to production environment"
                    
                    // Switch traffic to green environment
                    sh '/var/jenkins_home/scripts/deployment/blue-green-switch.sh green'
                    
                    // Monitor for 10 minutes
                    sh '/var/jenkins_home/scripts/monitoring/production-monitor.sh 600'
                }
            }
        }
        
        stage('Post-Deployment Verification') {
            steps {
                script {
                    echo "Performing post-deployment verification"
                    sh '/var/jenkins_home/scripts/monitoring/post-deployment-check.sh'
                    
                    // Send notification
                    sh '/var/jenkins_home/scripts/monitoring/notify-release.sh success "${env.RELEASE_NUMBER}"'
                }
            }
        }
    }
    
    post {
        failure {
            script {
                echo "Release failed, initiating rollback"
                sh '/var/jenkins_home/scripts/deployment/emergency-rollback.sh'
                sh '/var/jenkins_home/scripts/monitoring/notify-release.sh failure "${env.RELEASE_NUMBER}"'
            }
        }
        
        success {
            script {
                echo "Release completed successfully"
                sh '/var/jenkins_home/scripts/deployment/cleanup.sh'
            }
        }
        
        always {
            script {
                // Archive release artifacts
                archiveArtifacts artifacts: 'release-logs/**/*', allowEmptyArchive: true
                
                // Publish test results if available
                publishTestResults testResultsPattern: '**/TestResults/*.trx'
            }
        }
    }
}

def generateReleaseNumber() {
    def timestamp = new Date().format("yyyyMMdd-HHmmss")
    def buildNumber = env.BUILD_NUMBER ?: "0"
    return "v${timestamp}-${buildNumber}"
}