# MyFinance Infrastructure

This repository contains all infrastructure as code, deployment configurations, and automation scripts for the MyFinance application.

## ğŸ—ï¸ Repository Structure

```
MyFinance-Infrastructure/
â”œâ”€â”€ docker/                     # Docker configurations for deployment
â”‚   â”œâ”€â”€ blue-green/             # Blue-green deployment configurations
â”‚   â””â”€â”€ nginx/                  # nginx proxy configurations
â”œâ”€â”€ jenkins/                    # Jenkins CI/CD configurations
â”‚   â”œâ”€â”€ pipelines/              # Pipeline scripts (backend-release, frontend-release)
â”‚   â””â”€â”€ docker/                 # Jenkins container setup
â”œâ”€â”€ scripts/                    # Automation scripts
â”‚   â”œâ”€â”€ database/               # Database management scripts (migrate.sh)
â”‚   â”œâ”€â”€ deployment/             # Deployment automation (deploy-backend, deploy-frontend, blue-green-switch)
â”‚   â””â”€â”€ monitoring/             # Health check and monitoring scripts
â””â”€â”€ docs/                       # Documentation files (blue-green-flow.md, script-flow.md)
```

## ğŸš€ Getting Started

### ğŸ“š Documentation Guide

**Choose your path:**

1. **ğŸ†• New to Blue-Green Deployment?**
   - Start here: [`DEPLOYMENT-GUIDE.md`](DEPLOYMENT-GUIDE.md)
   - Complete guide with Jenkins automation
   - Time: 15-20 minutes

2. **âš¡ Quick Command Reference?**
   - Check: [`QUICK-REFERENCE.md`](QUICK-REFERENCE.md)
   - All commands in one place
   - For experienced users

### Prerequisites

- Docker Desktop
- Jenkins (containerized)
- Git
- Node.js 18+ (for frontend)
- .NET 9 SDK (for backend)

### Quick Setup

1. **Clone the infrastructure repository**
   ```bash
   git clone https://github.com/rocsa65/MyFinance-Infrastructure.git
   cd MyFinance-Infrastructure
   ```

2. **Start Jenkins container**
   ```bash
   cd jenkins/docker
   docker-compose up -d
   ```

3. **Access Jenkins**
   - URL: http://localhost:8081
   - Username: `admin`
   - Password: `admin123`

## ğŸ”„ Blue-Green Deployment

This infrastructure supports blue-green deployment strategy:

- **Blue Environment**: Currently active production environment
- **Green Environment**: New deployment target for testing before switching
- **nginx Proxy**: Routes traffic between blue and green environments

### Deployment Process

1. Deploy to green environment
2. Run health checks and integration tests
3. Switch traffic from blue to green
4. Monitor for 10 minutes
5. If issues detected, rollback to blue

## ğŸ“‹ Pipeline Overview

### Frontend Pipeline
- Pull from staging branch
- Run unit tests
- Run integration tests
- Run UI tests (Cypress)
- Build Docker image
- Push to GitHub Packages
- Deploy to green environment
- Run health checks
- Switch traffic if successful

### Backend Pipeline
- Pull from staging branch
- Run unit tests
- Run integration tests
- Run API health checks
- Build Docker image
- Push to GitHub Packages
- Deploy to green environment
- Run database migrations
- Run health checks
- Switch traffic if successful

## ğŸ—ƒï¸ Database Management

- **All Environments**: SQLite (file-based, embedded in API containers)
- **Blue Environment**: `/data/finance_blue.db` (SQLite database file)
- **Green Environment**: `/data/finance_green.db` (SQLite database file)
- **Migration**: Automated through Entity Framework Core migrations
- **Replication**: File-based copying between blue and green environments
- **Backup**: SQLite database files are backed up before migrations and deployments

## ğŸ“Š Monitoring

- Health checks every 30 seconds during deployment
- Automated rollback on health check failures
- Container-to-container health verification from Jenkins
- nginx traffic routing with zero-downtime switching

## ğŸ”§ Configuration

All configuration is handled through:
- **Jenkins Environment Variables**: Set in pipeline `environment` blocks
- **Docker Compose Files**: Environment-specific settings in blue/green compose files
- **Jenkins Credentials**: Secure secrets managed through Jenkins credentials store

Key values:
- `DOCKER_REGISTRY`: `ghcr.io/rocsa65` (hardcoded in scripts)
- `RELEASE_NUMBER`: Automatically generated by Jenkins pipelines
- `GITHUB_PACKAGES_TOKEN`: Stored in Jenkins credentials (for pushing images)

## ğŸ› ï¸ Manual Operations

### Switch Traffic (Manual)
```bash
# Switch both API and client to green environment
./scripts/deployment/blue-green-switch.sh green both

# Switch only API
./scripts/deployment/blue-green-switch.sh green api

# Switch only client
./scripts/deployment/blue-green-switch.sh green client
```

### Rollback (Emergency)
```bash
# Rollback both services to blue environment
./scripts/deployment/blue-green-switch.sh blue both

# Rollback only API
./scripts/deployment/blue-green-switch.sh blue api

# Rollback only client
./scripts/deployment/blue-green-switch.sh blue client
```

### Database Operations
```bash
# Run database migrations
./scripts/database/migrate.sh green

# Backup database manually
docker cp myfinance-api-green:/data/finance_green.db backup/
docker cp myfinance-api-blue:/data/finance_blue.db backup/
```

## ğŸ¤ Contributing

1. Create feature branch from `main`
2. Make infrastructure changes
3. Test in development environment
4. Create pull request
5. Deploy to staging for testing
6. Merge to main after approval

## ğŸ“ Release Notes

All infrastructure changes will be documented in [CHANGELOG.md](./CHANGELOG.md).